var keplerstars = [
{"rowid":3032, "kepid":10187017, "kepoi_name":"K00082.01", "kepler_name":"Kepler-102 e", "koi_disposition":"CONFIRMED", "koi_period":16.145671932, "koi_period_err1":7.44e-06, "koi_period_err2":-7.44e-06, "koi_time0bk":134.754877, "koi_time0bk_err1":0.000394, "koi_time0bk_err2":-0.000394, "koi_time0":2454967.755, "koi_time0_err1":0.000394, "koi_time0_err2":-0.000394, "koi_eccen":0, "koi_eccen_err1":"--", "koi_eccen_err2":"--", "koi_longp":"--", "koi_longp_err1":"--", "koi_longp_err2":"--", "koi_impact":0.75, "koi_impact_err1":0.016, "koi_impact_err2":-0.514, "koi_duration":3.7236, "koi_duration_err1":0.025, "koi_duration_err2":-0.025, "koi_ingress":"--", "koi_ingress_err1":"--", "koi_ingress_err2":"--", "koi_depth":941.1, "koi_depth_err1":4.2, "koi_depth_err2":-4.2, "koi_ror":0.030636, "koi_ror_err1":0.000272, "koi_ror_err2":-0.002572, "koi_srho":0.93462, "koi_srho_err1":1.54402, "koi_srho_err2":-0.07907, "koi_fittype":"LS+MCMC", "koi_prad":2.48, "koi_prad_err1":0.16, "koi_prad_err2":-0.1, "koi_sma":0.1162, "koi_sma_err1":"--", "koi_sma_err2":"--", "koi_incl":88.17, "koi_incl_err1":"--", "koi_incl_err2":"--", "koi_teq":546.0, "koi_teq_err1":"--", "koi_teq_err2":"--", "koi_insol":20.98, "koi_insol_err1":4.77, "koi_insol_err2":-3.16, "koi_dor":23.44, "koi_dor_err1":9.7, "koi_dor_err2":-9.7, "koi_num_transits":84, "koi_steff":4900.0, "koi_steff_err1":98.0, "koi_steff_err2":-98.0, "koi_slogg":4.602, "koi_slogg_err1":0.017, "koi_slogg_err2":-0.049, "koi_smet":0.08, "koi_smet_err1":0.15, "koi_smet_err2":-0.15, "koi_srad":0.741, "koi_srad_err1":0.048, "koi_srad_err2":-0.03, "koi_smass":0.806, "koi_smass_err1":0.033, "koi_smass_err2":-0.049, "koi_sage":"--", "koi_sage_err1":"--", "koi_sage_err2":"--", "koi_sparprov":"q1_q17_dr25_stellar", "ra":281.48273, "dec":47.208031, "koi_kepmag":11.492, "dist":111.93, "dist_err1":9.24, "dist_err2":6.72, "nconfp":5, "nkoi":6, "theta":0},
{"rowid":3080, "kepid":10187017, "kepoi_name":"K00082.02", "kepler_name":"Kepler-102 d", "koi_disposition":"CONFIRMED", "koi_period":10.31174786, "koi_period_err1":1.226e-05, "koi_period_err2":-1.226e-05, "koi_time0bk":134.07991, "koi_time0bk_err1":0.001, "koi_time0bk_err2":-0.001, "koi_time0":2454967.08, "koi_time0_err1":0.001, "koi_time0_err2":-0.001, "koi_eccen":0, "koi_eccen_err1":"--", "koi_eccen_err2":"--", "koi_longp":"--", "koi_longp_err1":"--", "koi_longp_err2":"--", "koi_impact":0.747, "koi_impact_err1":0.089, "koi_impact_err2":-0.528, "koi_duration":3.1818, "koi_duration_err1":0.0314, "koi_duration_err2":-0.0314, "koi_ingress":"--", "koi_ingress_err1":"--", "koi_ingress_err2":"--", "koi_depth":275.9, "koi_depth_err1":3.6, "koi_depth_err2":-3.6, "koi_ror":0.016563, "koi_ror_err1":0.000184, "koi_ror_err2":-0.001463, "koi_srho":0.89031, "koi_srho_err1":1.53461, "koi_srho_err2":-0.07428, "koi_fittype":"LS+MCMC", "koi_prad":1.34, "koi_prad_err1":0.09, "koi_prad_err2":-0.05, "koi_sma":0.0862, "koi_sma_err1":"--", "koi_sma_err2":"--", "koi_incl":87.5, "koi_incl_err1":"--", "koi_incl_err2":"--", "koi_teq":634.0, "koi_teq_err1":"--", "koi_teq_err2":"--", "koi_insol":38.13, "koi_insol_err1":8.66, "koi_insol_err2":-5.75, "koi_dor":17.1, "koi_dor_err1":7.4, "koi_dor_err2":-7.4, "koi_num_transits":126, "koi_steff":4900.0, "koi_steff_err1":98.0, "koi_steff_err2":-98.0, "koi_slogg":4.602, "koi_slogg_err1":0.017, "koi_slogg_err2":-0.049, "koi_smet":0.08, "koi_smet_err1":0.15, "koi_smet_err2":-0.15, "koi_srad":0.741, "koi_srad_err1":0.048, "koi_srad_err2":-0.03, "koi_smass":0.806, "koi_smass_err1":0.033, "koi_smass_err2":-0.049, "koi_sage":"--", "koi_sage_err1":"--", "koi_sage_err2":"--", "koi_sparprov":"q1_q17_dr25_stellar", "ra":281.48273, "dec":47.208031, "koi_kepmag":11.492, "dist":111.93, "dist_err1":9.24, "dist_err2":6.72, "nconfp":5, "nkoi":6, "theta":0},
{"rowid":3127, "kepid":10187017, "kepoi_name":"K00082.03", "kepler_name":"Kepler-102 f", "koi_disposition":"CONFIRMED", "koi_period":27.4536146, "koi_period_err1":0.0001077, "koi_period_err2":-0.0001077, "koi_time0bk":145.02866, "koi_time0bk_err1":0.00345, "koi_time0bk_err2":-0.00345, "koi_time0":2454978.029, "koi_time0_err1":0.00345, "koi_time0_err2":-0.00345, "koi_eccen":0, "koi_eccen_err1":"--", "koi_eccen_err2":"--", "koi_longp":"--", "koi_longp_err1":"--", "koi_longp_err2":"--", "koi_impact":0.765, "koi_impact_err1":0.142, "koi_impact_err2":-0.556, "koi_duration":3.747, "koi_duration_err1":0.101, "koi_duration_err2":-0.101, "koi_ingress":"--", "koi_ingress_err1":"--", "koi_ingress_err2":"--", "koi_depth":136.4, "koi_depth_err1":5.3, "koi_depth_err2":-5.3, "koi_ror":0.011753, "koi_ror_err1":0.001326, "koi_ror_err2":-0.001246, "koi_srho":1.27833, "koi_srho_err1":3.08403, "koi_srho_err2":-0.96089, "koi_fittype":"LS+MCMC", "koi_prad":0.95, "koi_prad_err1":0.06, "koi_prad_err2":-0.04, "koi_sma":0.1655, "koi_sma_err1":"--", "koi_sma_err2":"--", "koi_incl":88.82, "koi_incl_err1":"--", "koi_incl_err2":"--", "koi_teq":457.0, "koi_teq_err1":"--", "koi_teq_err2":"--", "koi_insol":10.34, "koi_insol_err1":2.35, "koi_insol_err2":-1.56, "koi_dor":37.1, "koi_dor_err1":17.9, "koi_dor_err2":-17.9, "koi_num_transits":48, "koi_steff":4900.0, "koi_steff_err1":98.0, "koi_steff_err2":-98.0, "koi_slogg":4.602, "koi_slogg_err1":0.017, "koi_slogg_err2":-0.049, "koi_smet":0.08, "koi_smet_err1":0.15, "koi_smet_err2":-0.15, "koi_srad":0.741, "koi_srad_err1":0.048, "koi_srad_err2":-0.03, "koi_smass":0.806, "koi_smass_err1":0.033, "koi_smass_err2":-0.049, "koi_sage":"--", "koi_sage_err1":"--", "koi_sage_err2":"--", "koi_sparprov":"q1_q17_dr25_stellar", "ra":281.48273, "dec":47.208031, "koi_kepmag":11.492, "dist":111.93, "dist_err1":9.24, "dist_err2":6.72, "nconfp":5, "nkoi":6, "theta":0},
{"rowid":3175, "kepid":10187017, "kepoi_name":"K00082.04", "kepler_name":"Kepler-102 c", "koi_disposition":"CONFIRMED", "koi_period":7.07136119, "koi_period_err1":3.085e-05, "koi_period_err2":-3.085e-05, "koi_time0bk":139.98763, "koi_time0bk_err1":0.00381, "koi_time0bk_err2":-0.00381, "koi_time0":2454972.988, "koi_time0_err1":0.00381, "koi_time0_err2":-0.00381, "koi_eccen":0, "koi_eccen_err1":"--", "koi_eccen_err2":"--", "koi_longp":"--", "koi_longp_err1":"--", "koi_longp_err2":"--", "koi_impact":0.658, "koi_impact_err1":0.292, "koi_impact_err2":-0.433, "koi_duration":2.757, "koi_duration_err1":0.111, "koi_duration_err2":-0.111, "koi_ingress":"--", "koi_ingress_err1":"--", "koi_ingress_err2":"--", "koi_depth":65.7, "koi_depth_err1":3.2, "koi_depth_err2":-3.2, "koi_ror":0.007798, "koi_ror_err1":0.002241, "koi_ror_err2":-0.000586, "koi_srho":1.27319, "koi_srho_err1":1.38305, "koi_srho_err2":-1.17782, "koi_fittype":"LS+MCMC", "koi_prad":0.63, "koi_prad_err1":0.04, "koi_prad_err2":-0.02, "koi_sma":0.067, "koi_sma_err1":"--", "koi_sma_err2":"--", "koi_incl":87.48, "koi_incl_err1":"--", "koi_incl_err2":"--", "koi_teq":719.0, "koi_teq_err1":"--", "koi_teq_err2":"--", "koi_insol":63.11, "koi_insol_err1":14.34, "koi_insol_err2":-9.52, "koi_dor":14.99, "koi_dor_err1":5.4, "koi_dor_err2":-5.4, "koi_num_transits":182, "koi_steff":4900.0, "koi_steff_err1":98.0, "koi_steff_err2":-98.0, "koi_slogg":4.602, "koi_slogg_err1":0.017, "koi_slogg_err2":-0.049, "koi_smet":0.08, "koi_smet_err1":0.15, "koi_smet_err2":-0.15, "koi_srad":0.741, "koi_srad_err1":0.048, "koi_srad_err2":-0.03, "koi_smass":0.806, "koi_smass_err1":0.033, "koi_smass_err2":-0.049, "koi_sage":"--", "koi_sage_err1":"--", "koi_sage_err2":"--", "koi_sparprov":"q1_q17_dr25_stellar", "ra":281.48273, "dec":47.208031, "koi_kepmag":11.492, "dist":111.93, "dist_err1":9.24, "dist_err2":6.72, "nconfp":5, "nkoi":6, "theta":0},
{"rowid":3238, "kepid":10187017, "kepoi_name":"K00082.06", "kepler_name":"--", "koi_disposition":"CANDIDATE", "koi_period":22.4098677, "koi_period_err1":0.0001651, "koi_period_err2":-0.0001651, "koi_time0bk":147.38366, "koi_time0bk_err1":0.00646, "koi_time0bk_err2":-0.00646, "koi_time0":2454980.384, "koi_time0_err1":0.00646, "koi_time0_err2":-0.00646, "koi_eccen":0, "koi_eccen_err1":"--", "koi_eccen_err2":"--", "koi_longp":"--", "koi_longp_err1":"--", "koi_longp_err2":"--", "koi_impact":0.869, "koi_impact_err1":0.077, "koi_impact_err2":-0.611, "koi_duration":2.271, "koi_duration_err1":0.203, "koi_duration_err2":-0.203, "koi_ingress":"--", "koi_ingress_err1":"--", "koi_ingress_err2":"--", "koi_depth":69.8, "koi_depth_err1":6.7, "koi_depth_err2":-6.7, "koi_ror":0.009062, "koi_ror_err1":0.001423, "koi_ror_err2":-0.001685, "koi_srho":2.18291, "koi_srho_err1":14.74722, "koi_srho_err2":-1.69824, "koi_fittype":"LS+MCMC", "koi_prad":0.73, "koi_prad_err1":0.05, "koi_prad_err2":-0.03, "koi_sma":0.1446, "koi_sma_err1":"--", "koi_sma_err2":"--", "koi_incl":88.71, "koi_incl_err1":"--", "koi_incl_err2":"--", "koi_teq":489.0, "koi_teq_err1":"--", "koi_teq_err2":"--", "koi_insol":13.55, "koi_insol_err1":3.08, "koi_insol_err2":-2.04, "koi_dor":38.7, "koi_dor_err1":18.7, "koi_dor_err2":-18.7, "koi_num_transits":53, "koi_steff":4900.0, "koi_steff_err1":98.0, "koi_steff_err2":-98.0, "koi_slogg":4.602, "koi_slogg_err1":0.017, "koi_slogg_err2":-0.049, "koi_smet":0.08, "koi_smet_err1":0.15, "koi_smet_err2":-0.15, "koi_srad":0.741, "koi_srad_err1":0.048, "koi_srad_err2":-0.03, "koi_smass":0.806, "koi_smass_err1":0.033, "koi_smass_err2":-0.049, "koi_sage":"--", "koi_sage_err1":"--", "koi_sage_err2":"--", "koi_sparprov":"q1_q17_dr25_stellar", "ra":281.48273, "dec":47.208031, "koi_kepmag":11.492, "dist":111.93, "dist_err1":9.24, "dist_err2":6.72, "nconfp":5, "nkoi":6, "theta":0},
{"rowid":3245, "kepid":10187017, "kepoi_name":"K00082.05", "kepler_name":"Kepler-102 b", "koi_disposition":"CONFIRMED", "koi_period":5.28691996, "koi_period_err1":2.947e-05, "koi_period_err2":-2.947e-05, "koi_time0bk":135.85427, "koi_time0bk_err1":0.00452, "koi_time0bk_err2":-0.00452, "koi_time0":2454968.854, "koi_time0_err1":0.00452, "koi_time0_err2":-0.00452, "koi_eccen":0, "koi_eccen_err1":"--", "koi_eccen_err2":"--", "koi_longp":"--", "koi_longp_err1":"--", "koi_longp_err2":"--", "koi_impact":0.705, "koi_impact_err1":0.23, "koi_impact_err2":-0.494, "koi_duration":2.579, "koi_duration_err1":0.136, "koi_duration_err2":-0.136, "koi_ingress":"--", "koi_ingress_err1":"--", "koi_ingress_err2":"--", "koi_depth":41.5, "koi_depth_err1":2.9, "koi_depth_err2":-2.9, "koi_ror":0.006312, "koi_ror_err1":0.001203, "koi_ror_err2":-0.000595, "koi_srho":0.96999, "koi_srho_err1":1.54014, "koi_srho_err2":-0.83393, "koi_fittype":"LS+MCMC", "koi_prad":0.51, "koi_prad_err1":0.03, "koi_prad_err2":-0.02, "koi_sma":0.0552, "koi_sma_err1":"--", "koi_sma_err2":"--", "koi_incl":86.41, "koi_incl_err1":"--", "koi_incl_err2":"--", "koi_teq":792.0, "koi_teq_err1":"--", "koi_teq_err2":"--", "koi_insol":92.97, "koi_insol_err1":21.13, "koi_insol_err2":-14.02, "koi_dor":11.27, "koi_dor_err1":4.5, "koi_dor_err2":-4.5, "koi_num_transits":228, "koi_steff":4900.0, "koi_steff_err1":98.0, "koi_steff_err2":-98.0, "koi_slogg":4.602, "koi_slogg_err1":0.017, "koi_slogg_err2":-0.049, "koi_smet":0.08, "koi_smet_err1":0.15, "koi_smet_err2":-0.15, "koi_srad":0.741, "koi_srad_err1":0.048, "koi_srad_err2":-0.03, "koi_smass":0.806, "koi_smass_err1":0.033, "koi_smass_err2":-0.049, "koi_sage":"--", "koi_sage_err1":"--", "koi_sage_err2":"--", "koi_sparprov":"q1_q17_dr25_stellar", "ra":281.48273, "dec":47.208031, "koi_kepmag":11.492, "dist":111.93, "dist_err1":9.24, "dist_err2":6.72, "nconfp":5, "nkoi":6, "theta":0},
]

/////////// convenience functions
function convertL(inputRA, inputdec){
                    var Lnaught = 122.93*(Math.PI/180);
                    var Anaught = 192.86*(Math.PI/180);
                    var Dnaught = 27.13*(Math.PI/180);
                    var L;
                    var inputRA_radians = inputRA*(Math.PI/180)
                    var inputdec_radians = inputdec*(Math.PI/180)


                    L =  (Lnaught - Math.atan2(((Math.cos(inputdec_radians)) * (Math.sin(inputRA_radians - Anaught))), 
                        (((Math.sin(inputdec_radians)) * (Math.cos(Dnaught))) - ((Math.cos(inputdec_radians)) * 
                          (Math.sin(Dnaught)) * (Math.cos(inputRA_radians - Anaught))))));

                    return L*(180/Math.PI); }

function convertB(inputRA, inputdec){
                    var Anaught = 192.86*(Math.PI/180);
                    var Dnaught = 27.13*(Math.PI/180);
                    var B;
                    var inputRA_radians = inputRA*(Math.PI/180)
                    var inputdec_radians = inputdec*(Math.PI/180)

                    B =  (Math.asin(((Math.sin(inputdec_radians))*(Math.sin(Dnaught)))+((Math.cos(inputdec_radians))*(Math.cos(Dnaught))*(Math.cos(inputRA_radians-Anaught)))))
                   
                    //console.log(B);
                    return B*(180/Math.PI);}

function convertXYZ(distance, xyzinputRA, xyzinputdec){
                var l = convertL(inputRA=xyzinputRA, inputdec=xyzinputdec);
                var b = convertB(inputRA=xyzinputRA, inputdec=xyzinputdec);

                l=l*(Math.PI/180);

                b=b*(Math.PI/180);

                var x_star = distance * (Math.cos(l)) * (Math.cos(b));
                // console.log(x_star)

                var y_star = distance*(Math.cos(b))*(Math.sin(l));
                // console.log(y_star)

                var z_star = distance * (Math.sin(b));
                // console.log(z_star)

                var xyz_list = [x_star, y_star, z_star];

                return xyz_list;}
                
///////////////////////////////////////////////////////////////////////////
//////////////////////////// Create Scales ////////////////////////////////
///////////////////////////////////////////////////////////////////////////

//Create color gradient for stars based on their size and temperature

function return_steff_minmax(keplerstars){
      var currentMinimum = 1000000;
      var currentMaximum = 0;
      var currentSteff;

      for(i=0; i<keplerstars.length; i++){
            currentSteff = keplerstars[i].koi_steff;

            if(currentSteff < currentMinimum){
                  currentMinimum = currentSteff;
            }

            if(currentSteff > currentMaximum){
                  currentMaximum = currentSteff;
            }

      }
      return [currentMinimum, currentMaximum];
      
      }
steffMin = return_steff_minmax(keplerstars)[0]
steffMax = return_steff_minmax(keplerstars)[1]      

//var keplerstarscolors = ["#D86865","#F3C4C4","#D0EEFD","#99DAFB","#1B90CB"]; //color scale from James
var keplerstarscolors = ["#9C1E1E","#D62828","#E16262","#F3C4C4","#738E9B","#45687A","#2E556A","#174259","#001F2F"];
var keplerstarscolorScale = d3.scale.linear()
	 .domain([2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000]) // Temperatures
	 //.domain([steffMin, steffMax]) //james
	 .range(keplerstarscolors);
	
var kepleropacityScale = d3.scale.linear()	
	.domain([0, 1000])
	.range([0, 1]);

function return_teq_minmax(keplerstars){
      var currentMinimum = 1000000;
      var currentMaximum = 0;
      var currentTeq;

      for(i=0; i<keplerstars.length; i++){
            currentTeq = keplerstars[i].koi_teq;

            if(currentTeq < currentMinimum){
                  currentMinimum = currentTeq;
            }

            if(currentTeq > currentMaximum){
                  currentMaximum = currentTeq;
            }

      }
      return [currentMinimum, currentMaximum];
      
      }
teqMin = return_teq_minmax(keplerstars)[0]
teqMax = return_teq_minmax(keplerstars)[1]
var keplerplanetcolors = ["#FAD8D7","#F5A5A3","#F49896","#F0726F","#EF6461"];
var keplerplanetcolorScale= d3.scale.linear()
	.domain([teqMin, teqMax])
	.range(keplerplanetcolors);

function return_sma_minmax(keplerstars){
      var currentMinimum = 1000000;
      var currentMaximum = 0;
      var currentSMA;

      for(i=0; i<keplerstars.length; i++){
            currentSMA = keplerstars[i].koi_sma;

            if(currentSMA < currentMinimum){
                  currentMinimum = currentSMA;
            }

            if(currentSMA > currentMaximum){
                  currentMaximum = currentSMA;
            }

      }
      return [currentMinimum, currentMaximum];
      
      }

smaMin = return_sma_minmax(keplerstars)[0] //get minimum and maximum radii -James
smaMax = return_sma_minmax(keplerstars)[1]
//console.log(smaMin);
//console.log(smaMax);
var smaScale = d3.scale.linear()
      .domain([0, smaMax])
      .range([500, 5000]); //james

function return_ror_minmax(keplerstars){
      var currentMinimum = 1000000;
      var currentMaximum = 0;
      var currentRadius;

      for(i=0; i<keplerstars.length; i++){
            currentRadius = keplerstars[i].koi_ror;

            if(currentRadius < currentMinimum){
                  currentMinimum = currentRadius;
            }

            if(currentRadius > currentMaximum){
                  currentMaximum = currentRadius;
            }

      }
      return [currentMinimum, currentMaximum];
      
      }

rorMin = return_ror_minmax(keplerstars)[0] //get minimum and maximum radii -James
rorMax = return_ror_minmax(keplerstars)[1]
var rorScale = d3.scale.linear()
      .domain([0, rorMax])
      .range([1, 100]); //james

//Set scale for radius of circles
//new function to find minimum and maximum stellar radius across the entire data set -James
function return_radius_minmax(keplerstars){
	var currentMinimum = 1000000;
	var currentMaximum = 0;
	var currentRadius;

	for(i=0; i<keplerstars.length; i++){
		currentRadius = keplerstars[i].koi_srad;

		if(currentRadius < currentMinimum){
			currentMinimum = currentRadius;
		}

		if(currentRadius > currentMaximum){
			currentMaximum = currentRadius;
		}

	}
	return [currentMinimum, currentMaximum];
	
	}

radMin = return_radius_minmax(keplerstars)[0] //get minimum and maximum radii -James
radMax = return_radius_minmax(keplerstars)[1]
var rScale = d3.scale.linear()
	.domain([0, radMax])
	.range([5, 30]); //james

//caroline & catherine: planet size
var pScale = d3.scale.linear()
	.domain([0, 5])
	.range([5, 200]); 

//scale x, y, and z "axes"
var xScale = d3.scale.linear()
    .domain([0, 15000])
    .range([0,15000]);
var yScale = d3.scale.linear()
    .domain([0, 15000])
    .range([0,15000])
var zScale = d3.scale.linear()
    .domain([0, 15000])
    .range([0,15000]);
///////////////////////////////////////////////////////////////////////////
/////////////////////////      Main         ///////////////////////////////
///////////////////////////////////////////////////////////////////////////

//Width and Height of the SVG
var 
	w = window,
	d = document,
	e = d.documentElement,
	g = d.getElementsByTagName('body')[0],
	x = ((w.innerWidth || e.clientWidth || g.clientWidth) - 50),
	y = ((w.innerHeight|| e.clientHeight|| g.clientHeight) - 150);

// window.onresize = updateWindow;	

//a function that x3dom uses to attach an "appearance" and "color" to a data selection.
//If you subsequently append a shape to that selection, x3dom will render the shape in 3D with this appearance/color. -ES
var makeSolid = function(selection, color, opacity) {
            selection.append("appearance")
                .append("material")
                .attr("diffuseColor", color || "black")
                .attr("transparency", function(){return 1 - opacity;})
            return selection;
        };

///////////////////////////////////////////////////////////////////////////
///////////////////////// Initiate elements ///////////////////////////////
///////////////////////////////////////////////////////////////////////////

var stopTooltip = false;	
//Planet orbit variables
//The larger this is the more accurate the speed is
var resolution = 1, //sets behavior or animation orbit
	speedUp = 400, //speed of planets
	au = 149597871, //km
	radiusSun = 695800, //km
	radiusJupiter = 69911; //km
	phi=0;

//number of times we've drawn a planet view
var nPlanetViewDraws = 0;
var timer;

var formatSI = d3.format(".2f");
//Angle conversion functions

function toRadians (angle) { return angle * (Math.PI / 180);}
function toDegrees (angle) { return angle * (180 / Math.PI);}

//In the html code, we've created an object of ID "chartholder" within <x3d> tags. Here, we set the dimensions of that object. -ES
var x3d = d3.select("#chartholder")
			.attr("class","x3dom-canvas")
            .attr("width", x + "px")
            .attr("height", y + "px")
            .attr("showLog", "false")
            .attr("showStat", "false");

//create the scene
var scene = x3d.append("scene")
				        .attr("class","x3dom-scene")
                //.attr("id","theScene");

var sceneToRef = scene._groups[0][0]
sceneToRef.setAttribute("id","theScene")

//starts camera at ideal viewpoint
var view = 'galaxy';
var view_pos = [0, 50, 5000]; //x, y, z relative to origin (0, 0, 0)
//var view_pos = [-37902.27708, -31717.63386, -17253.83076]; //new view_pos and fov -Chris
var fov = 0.05; 	// Preferred minimum viewing angle from this viewpoint in radians. 
				// Small field of view roughly corresponds to a telephoto lens, 
				// large field of view roughly corresponds to a wide-angle lens. 
				// Hint: modifying Viewpoint distance to object may be better for zooming. 
				// Warning: fieldOfView may not be correct for different window sizes and aspect ratios. 

var view_or = [1, 0, 0, 0]; //relative to default (0, 0, 1, 0)
var zN = 0; 		//near plane
var zF = 150000;	//far plane

var viewpoint = scene.append("viewpoint")
  .attr("id", "vp")
  .attr("position", view_pos.join(" "))
  .attr("orientation", view_or.join(" "))
  .attr("fieldOfView", fov)
  .attr('centerOfRotation', "0 0 0")
  .attr('zNear', zN)
  .attr('zFar', zF)
  //.attr("description", "defaultX3DViewpointNode").attr("set_bind", "true");

///////////////////////////////////////////////////////////////////////////
/////////////////////////// Plot stars //////////////////////////////////
///////////////////////////////////////////////////////////////////////////

//Draw the Kepler stars			
var drawn_keplerstars = scene.selectAll(".keplerstar")
							 .data(keplerstars)
            				 .enter()
            				 .append('transform')
            				 .attr('translation', function(d){ 
            				    var xyz = convertXYZ(distance=d.dist, xyzinputRA=d.ra, xyzinputdec=d.dec);
								        var x = xyz[0];
								        var y = xyz[1];
								        var z = xyz[2];

                        d.x = xScale(x);
                        d.y = yScale(y);
                        d.z = zScale(z);

            				    return xScale(x) + ' ' + yScale(y) + ' ' + zScale(z);})
            				 .attr('class', 'keplerstar')
                     .append('shape')                
            				 .call(makeSolid, color=function(d){
            				 return keplerstarscolorScale(d.koi_steff)}, opacity=1)  
            				 .append('sphere')
            				 .attr('radius', function(d) {return 0.25*rScale(d.koi_srad)}) 

// draw a cylinder to represent the Milky Way disk
var cylinder = [{"height":20, "radius":2000, "rotaxis_xcoord":1, "rotaxis_ycoord":0, "rotaxis_zcoord":0, "rot_angle":1.570796}];

var drawn_cylinder = scene.selectAll(".cylinder") 	
					.data(cylinder)				
					.enter()					
					.append('transform')
					.attr('rotation', function(d){    //specify that this "transform" will impose a rotation of the circle
						return d.rotaxis_xcoord + ' ' + d.rotaxis_ycoord + ' ' + d.rotaxis_zcoord + ' ' + d.rot_angle;
					})
					.attr('class', 'MWdisk')
          .append('shape')					//for each circle, append an as-yet-unspecified shape to be drawn on our 3D canvas
					.call(makeSolid, color='blue', opacity=0.4) 			//set the color
          			.append('cylinder')					//make the shape a 2D circle
					.attr('radius', function(d){return d.radius;})	//set the radius
					.attr('height', function(d){return d.height})
					.attr('subdivision',40)
drawn_cylinder.exit().remove()


// Enable switch to "Earth view," i.e. view from the Kepler satellite
function earthView() {
        console.log("beginning earthView");
        console.log(sceneToRef);
        console.log(sceneToRef.childNodes.length);
        view = 'earth';
        stopTooltip=false;
				var fov = 0.25;
				var view_pos = [-117.67830, -491.90906, -114.90123]
				var view_or = [0.98242, 0.00872, -0.18650, 1.87139]
				var zN = -1000;
				var zF = 10000;

				viewpoint.attr("position", view_pos.join(" "))
				    .attr("orientation", view_or.join(" "))
				    .attr('zNear', zN)
  				  .attr('zFar', zF)
  				  .attr("fieldOfView", fov)
            .attr('centerOfRotation', "0 0 0");
        }

// Enable switch back to "Galaxy view"
function galaxyView() {
        console.log("beginning galaxyView");
        console.log(sceneToRef);
        console.log(sceneToRef.childNodes.length);

        view = 'galaxy';
	      stopTooltip=false;
				var view_pos = [0, 50, 5000];
				var view_or = [1, 0, 0, 0]; 
				var fov = 0.05;
				var zN = 0; 
				var zF = 150000;

				viewpoint.attr("position", view_pos.join(" "))
				    .attr("orientation", view_or.join(" "))
				    .attr("fieldOfView", fov)
				    .attr('centerOfRotation', "0 0 0")
				    .attr('zNear', zN)
  				  .attr('zFar', zF)
  			
        if(nPlanetViewDraws > 0){
          timer.stop();
        }
				}

function planetView(system_kepID){
  //remove earlier-drawn planetary system ,if there is one
  if(nPlanetViewDraws > 0){
    $('#theScene > .planetHost').remove();
    $('#theScene > .planet').remove();
    $('#theScene > .orbit').remove();
    $('#theScene > .zone').remove();
    $('#theScene > .zoneUD').remove();
  }
  
  //make the tooltip go away
  stopTooltip = true;

  //fly away to a random point in space to draw the planet view
  var fov = 0.005;
  var view_pos = [49995.04201, 9644.33980, 11280]
  var view_or = [0.58043, 0.57246, 0.57913, 2.08821]
  var zN = 0;
  var zF = 5000000;
  var cor = [10000, 10000, 11000]

  viewpoint.attr("position", view_pos.join(" "))
    .attr("orientation", view_or.join(" "))
    .attr('zNear', zN)
    .attr('zFar', zF)
    .attr("fieldOfView", fov)
    .attr("centerOfRotation", cor);

  //display the system
  var solarRad_to_AU = 0.00465046726;
  var to_draw = [];
  var scales_arr = [];
  var planetToDraw;
  var drawn_planetHost;
  
  for(i=0;i<keplerstars.length;i++){
    if(keplerstars[i].kepid == system_kepID){
      //make a copy of this object to hold its data
      planetToDraw = {};

      //empty this object out
      for (var member in planetToDraw) delete planetToDraw[member];

      //make a copy of this object to use its data
      planetToDraw = $.extend(true,{},keplerstars[i]) //JSON.parse(JSON.stringify(keplerstars[i]))
      to_draw.push(planetToDraw);

      scales_arr.push(planetToDraw.koi_srad * solarRad_to_AU);
      scales_arr.push(planetToDraw.koi_srad * planetToDraw.koi_ror * solarRad_to_AU);
      scales_arr.push(planetToDraw.koi_srad * planetToDraw.koi_dor * solarRad_to_AU);
      scales_arr.push((Math.pow(planetToDraw.koi_steff,2)/Math.pow(273,2))*((planetToDraw.koi_srad * solarRad_to_AU)/2)); //outer HZ radius
      }
  }

  var smaMin = d3.min(scales_arr);
  var smaMax = d3.max(scales_arr);
  var smaScale = null;                          
  smaScale = d3.scale.linear()
                  .domain([smaMin, smaMax])
                  //.range([1, max_to_min_ratio]);
                  .range([1.5, x/1.5]);

  drawn_planetHost = scene.selectAll(".planetHost")
                        .data([to_draw[0]])
                         .enter()
                         .append('transform')
                         .attr('class', 'planetHost')
                         .attr('translation', '10000 10000 11000')
                         .attr('scale','10 10 10')
                         .append('shape')
                         .call(makeSolid, color=function(d){
                          return keplerstarscolorScale(d.koi_steff)}, opacity=1)
                         .append('sphere')
                         //.attr('radius', 10)
                         //.append('box')
                         //.attr('size', '10 10 10') //why does box work, but not sphere??
                         ;
  
  var drawn_planet = scene.selectAll(".planet")
                          .data(to_draw)
                           .enter()
                           .append('transform')
                           .attr('translation', function(d){return 10000+smaScale(d.koi_srad*d.koi_dor*solarRad_to_AU) + ' ' + 10000 + ' ' + 11000})
                           .attr('scale','2 2 2')
                           .attr('class','planet')
                           .append('shape')
                           .call(makeSolid, color=function(d){return keplerplanetcolorScale(d.koi_teq)}, opacity = 1) 
                           .append('sphere')
                           //.attr('radius', '20')
                           //.append('box')
                           //.attr('size', '2 2 2') //why does box work, but not sphere??
                           ;
  
  scene.selectAll(".orbit")   
                  .data(to_draw)        
                  .enter()          
                  .append('transform')    
                  .attr('class', 'orbit')
                  .attr('id', function(d){return d.kepoi_name + "_orbit"})
                  .attr('translation', '10000 10000 11000')
                  .attr('scale', function(d){return smaScale(d.koi_srad*d.koi_dor*solarRad_to_AU)+ ' ' +  smaScale(d.koi_srad*d.koi_dor*solarRad_to_AU) + ' 1';})
                  .append('shape')         
                  .call(makeSolid, color='black', opacity=1)      
                  .append('Circle2D')   
                  //.attr('radius', function(d){return smaScale(d.koi_srad*d.koi_dor*solarRad_to_AU);})
                  .attr('subdivision','500')
                  ;
  
  var drawn_zone = scene.selectAll(".zone")
                          .data(to_draw)
                          .enter()
                          .append('transform')
                          .attr('class', 'zone')
                          .attr('translation', '10000 10000 11000')
                          .append('shape')
                          .call(makeSolid, color= 'lightskyblue', opacity=1)
                          .append('Disk2D')
                          .attr('innerradius', function(d){return smaScale((Math.pow(d.koi_steff,2)/Math.pow(373,2))*((d.koi_srad * solarRad_to_AU)/2))})
                          .attr('outerradius', function(d){return smaScale((Math.pow(d.koi_steff,2)/Math.pow(273,2))*((d.koi_srad * solarRad_to_AU)/2))})
                          .attr('subdivision', 50)
                
  var drawn_zoneUpsideDown = scene.selectAll(".zoneUD")
                          .data(to_draw)
                          .enter()
                          .append('transform')
                          .attr('class', 'zoneUD')  
                          .attr('translation', '10000 10000 11000')  
                          .attr('rotation', '1 0 0 3.14159') //flip over
                          .append('shape')
                          .call(makeSolid, color= 'lightskyblue', opacity=1)
                          .append('Disk2D')
                          .attr('innerradius', function(d){return smaScale((Math.pow(d.koi_steff,2)/Math.pow(373,2))*((d.koi_srad * solarRad_to_AU)/2))})
                          .attr('outerradius', function(d){return smaScale((Math.pow(d.koi_steff,2)/Math.pow(273,2))*((d.koi_srad * solarRad_to_AU)/2))})
                          .attr('subdivision', 50)
  drawn_zoneUpsideDown.exit().remove()
  
  //Calculate the new x or y position per planet
  function locate() {
    return function(d){
      var k = 360 / (d.koi_period * resolution * speedUp);
      for (var i = 0; i < resolution; i++) {
        d.theta += k;
      }
    
      if (d.theta > 360){
        d.theta -= 360;
      }

      var newX_shifted = smaScale(d.koi_srad*d.koi_dor*solarRad_to_AU)*Math.cos(toRadians(d.theta)) + 10000;
      var newY_shifted = smaScale(d.koi_srad*d.koi_dor*solarRad_to_AU)*Math.sin(toRadians(d.theta)) + 10000;

      return newX_shifted + ' ' + newY_shifted + ' ' + 11000;};
  }

  //Change x and y location of each planet
  timer = d3.timer(function() {
                scene.selectAll(".planet")
                      .attr('translation', locate());
              });

  //increment counter of planet view draws
  nPlanetViewDraws += 1;
  
}



//Show the tooltip on hover
function showTooltip(d, coords) {	
	
	var xpos = coords.x;
	var ypos = coords.y;

	d3.select("#tooltip")
		.style('top',ypos+"px")
		.style('left',xpos+"px")
		.transition().duration(500)
		.style('opacity',1);
		
	//Keep the tooltip moving with the planet, until stopTooltip 
	//returns true (when the user clicks)
	d3.timer(function(elapsed) {
	  //Breaks from the timer function when stopTooltip is changed to true
	  //by another function
	  if (stopTooltip == true) { 
		//Hide tooltip
		d3.select("#tooltip").transition().duration(25)
			.style('opacity',0)
		}
	});

	var display_name;

	if (d.kepler_name=="--"){
		display_name = d.kepoi_name;
	}
	else {
		display_name = d.kepler_name;
	}

	//Change the texts inside the tooltip
	d3.select("#tooltip .tooltip-planet").text(display_name);
	d3.select("#tooltip-temperature")	.html("Temperature of star: " + d.koi_steff + " Kelvin");
	d3.select("#tooltip-radius")		.html("Radius of star: " + formatSI(d.koi_srad) + " Solar radii");
	d3.select("#tooltip-depth")			.html("Stellar light lost: " + formatSI(d.koi_depth) + " PPM");
	d3.select("#tooltip-duration")		.html("Duration of planet transit: " + formatSI(d.koi_duration) + " hours");
	d3.select("#tooltip-ratio")			.html("Planet-Star Radius Ratio: " + formatSI(d.koi_ror) + " AU");
	d3.select("#tooltip-count")			.html("Number of planets: " + d.nkoi);
	d3.select("#tooltip-mass")			.html("Mass of star: " + formatSI(d.koi_smass) + " Solar mass");
	d3.select("#tooltip-button")		.html("<button onclick=planetView("+d.kepid+")>Planet View</button>");
}//showTooltip	



/////// onclick behavior for stars
function getRelativeCoords(event) {
    return { x: event.offsetX, y: event.offsetY };
}

var all_keplerstars = document.getElementsByClassName("keplerstar");

for (i=0; i < all_keplerstars.length; i++) {
    all_keplerstars[i].onclick = function(d){
    	coords = getRelativeCoords(event);
      stopTooltip = false;
		  showTooltip(d.hitObject.__data__, coords);
    }
}